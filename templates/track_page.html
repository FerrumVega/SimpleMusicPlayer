<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>{{ song_full_name }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body class="theme-dark">
    <div>
        <h1>{{ song_full_name }}</h1>
        <img src="{{ song_cover }}" class="bouncing-img"></img>
        <audio controls src="{{ song_url }}" preload="metadata" id="player"></audio>
        <a href="like">
            <button type="button">
                ‚ù§Ô∏è
            </button>
        </a>
        <a href="dislike">
            <button type="button">
                üíî
            </button>
        </a>
        <a href="{{ previous_track_url }}">
            <button type="button">
                –ü—Ä–µ–¥—ã–¥—É—â–∏–π —Ç—Ä–µ–∫
            </button>
        </a>
        <a href="{{ next_track_url }}">
            <button type="button" id="next_button">
                –°–ª–µ–¥—É—é—â–∏–π —Ç—Ä–µ–∫
            </button>
        </a>
        <a href="/">
            <button type="button">
                –ù–∞ –≥–ª–∞–≤–Ω—É—é
            </button>
        </a>
        <p>{{ song_lyrics|safe }}</p>
    </div>
    <script>
        let player = document.getElementById("player")
        let img = document.querySelector(".bouncing-img")
        player.addEventListener("play", () => { img.style.animation = "bouncing 7s infinite"; })
        player.addEventListener("pause", () => { img.style.animation = "none"; })
        if (new URLSearchParams(window.location.search).has("from_wave")) {
            let trackId = window.location.pathname.split("/")[2]
            let listened = false
            player.addEventListener("timeupdate", () => {
                let playerPos = player.currentTime
                if (playerPos / player.duration >= 0.8 && !listened) {
                    navigator.sendBeacon(`/feedback/ended/?player_pos=${playerPos}&track_id=${trackId}`)
                    listened = true
                }
            })

            let next_button = document.getElementById("next_button")
            next_button.addEventListener("click", () => {
                if (!listened) {
                    let playerPos = player.currentTime
                    navigator.sendBeacon(`/feedback/skipped/?player_pos=${playerPos}&track_id=${trackId}`)
                }
            })
        }
    </script>
</body>

</html>